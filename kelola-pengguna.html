<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Pengguna - Apple Sale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #ee4d2d 0%, #ff6533 50%, #ff7337 100%);
        }
        
        .premium-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #ef4444;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ee4d2d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        
        .sidebar.collapsed .logo-text {
            display: none;
        }
        
        .content {
            transition: all 0.3s ease;
        }
        
        .content.expanded {
            margin-left: 80px;
        }
        
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .mobile-menu.open {
            right: 0;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .mobile-menu-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .mobile-menu-nav {
            padding: 1rem 0;
        }
        
        .mobile-menu-nav a {
            display: block;
            padding: 0.75rem 1rem;
            color: #4b5563;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .mobile-menu-nav a:hover {
            background-color: #f3f4f6;
            color: #ee4d2d;
        }
        
        .mobile-menu-nav a.active {
            color: #ee4d2d;
            background-color: #fffbeb';
        }
        
        .mobile-menu-divider {
            height: 1px;
            background-color: #e5e7eb;
            margin: 0.5rem 0;
        }
        
        .verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .verification-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .verification-modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .verification-modal.show .verification-modal-content {
            transform: scale(1);
        }
        
        .ktp-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-badge.verified {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.not-uploaded {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="text-center">
            <h3 id="loadingTitle" class="text-xl font-bold text-gray-800 mb-2">Memuat...</h3>
            <p id="loadingMessage" class="text-gray-600 mb-4">Mohon tunggu sebentar</p>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="mobile-menu-header">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                    <i class="fas fa-mobile-alt text-white text-base"></i>
                </div>
                <span class="text-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">Apple Sale</span>
            </div>
            <button id="mobileMenuClose" class="mobile-menu-close" onclick="toggleMobileMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="dashboard.html">
                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </a>
            <a href="kelola-pengguna.html" class="active">
                <i class="fas fa-users mr-2"></i> Kelola Pengguna
            </a>
            <a href="kelola-produk.html">
                <i class="fas fa-box mr-2"></i> Kelola Produk
            </a>
            <a href="kelola-pesanan.html">
                <i class="fas fa-shopping-cart mr-2"></i> Kelola Pesanan
            </a>
            <a href="laporan.html">
                <i class="fas fa-chart-bar mr-2"></i> Laporan
            </a>
            <div class="mobile-menu-divider"></div>
            <a href="#" onclick="logout()">
                <i class="fas fa-sign-out-alt mr-2"></i> Keluar
            </a>
        </nav>
    </div>
    
    <!-- Verification Modal -->
    <div id="verificationModal" class="verification-modal">
        <div class="verification-modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Verifikasi KTP</h3>
                    <button onclick="closeVerificationModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <img id="modalUserAvatar" class="user-avatar mr-3" src="https://via.placeholder.com/40" alt="User Avatar">
                        <div>
                            <h4 id="modalUserName" class="font-bold text-gray-800">Loading...</h4>
                            <p id="modalUserEmail" class="text-sm text-gray-600">Loading...</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="font-medium text-gray-700 mb-2">Dokumen KTP</h5>
                        <img id="modalKtpImage" class="ktp-image w-full" src="https://via.placeholder.com/600" alt="KTP Image">
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="font-medium text-gray-700 mb-2">Catatan Verifikasi</h5>
                        <textarea id="verificationNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent" rows="3" placeholder="Tambahkan catatan untuk verifikasi ini..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="rejectVerification()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>Tolak
                        </button>
                        <button onclick="approveVerification()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition-colors">
                            <i class="fas fa-check mr-2"></i>Setujui
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-mobile-alt text-white text-xl"></i>
                    </div>
                    <span class="logo-text text-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">Apple Sale</span>
                </div>
                <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4">
            <div class="flex items-center space-x-3 mb-6">
                <div class="relative">
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                    <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                </div>
                <div>
                    <p class="sidebar-text font-medium text-gray-800">Admin</p>
                    <p class="sidebar-text text-sm text-gray-600">admin@applesale.com</p>
                </div>
            </div>
            
            <nav>
                <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 mb-2">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="kelola-pengguna.html" class="flex items-center space-x-3 p-3 rounded-lg bg-orange-50 text-orange-600 mb-2">
                    <i class="fas fa-users"></i>
                    <span class="sidebar-text">Kelola Pengguna</span>
                </a>
                <a href="kelola-produk.html" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 mb-2">
                    <i class="fas fa-box"></i>
                    <span class="sidebar-text">Kelola Produk</span>
                </a>
                <a href="kelola-pesanan.html" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 mb-2">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="sidebar-text">Kelola Pesanan</span>
                </a>
                <a href="laporan.html" class="flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 mb-2">
                    <i class="fas fa-chart-bar"></i>
                    <span class="sidebar-text">Laporan</span>
                </a>
                <div class="border-t border-gray-200 my-4"></div>
                <a href="#" onclick="logout()" class="flex items-center space-x-3 p-3 rounded-lg text-red-600 hover:bg-red-50">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="sidebar-text">Keluar</span>
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="content" class="content ml-64 min-h-screen">
        <!-- Top Navigation -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700 focus:outline-none mr-4">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="text-xl font-bold text-gray-800">Kelola Pengguna</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-500 hover:text-gray-700 relative">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <button class="md:hidden text-gray-500 hover:text-gray-700" onclick="toggleMobileMenu()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Users Management Content -->
        <main class="p-6">
            <!-- Filters and Search -->
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 md:mb-0">Daftar Pengguna</h2>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Cari pengguna..." class="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                            <option value="">Semua Status</option>
                            <option value="verified">Terverifikasi</option>
                            <option value="pending">Menunggu Verifikasi</option>
                            <option value="not-uploaded">Belum Upload</option>
                        </select>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-users text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total Pengguna</p>
                                <p class="text-xl font-bold text-gray-800" id="totalUsersCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Terverifikasi</p>
                                <p class="text-xl font-bold text-gray-800" id="verifiedUsersCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Menunggu Verifikasi</p>
                                <p class="text-xl font-bold text-gray-800" id="pendingUsersCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengguna</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kontak</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terdaftar</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="usersTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" onclick="changePage('prev')" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Previous
                        </button>
                        <button id="nextPageMobile" onclick="changePage('next')" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Menampilkan <span id="startItem" class="font-medium">1</span> sampai <span id="endItem" class="font-medium">10</span> dari <span id="totalItems" class="font-medium">0</span> hasil
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prevPage" onclick="changePage('prev')" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div id="pageNumbers" class="flex">
                                    <!-- Page numbers will be populated by JavaScript -->
                                </div>
                                <button id="nextPage" onclick="changePage('next')" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBRt-74qBrtvop8J7YOWtDOS7gBMp0dsiQ",
            authDomain: "kredit-hp-221a1.firebaseapp.com",
            projectId: "kredit-hp-221a1",
            storageBucket: "kredit-hp-221a1.firebasestorage.app",
            messagingSenderId: "428804203261",
            appId: "1:428804203261:web:51aa0bb8d4a65080a25494",
            measurementId: "G-EJW00GWVS9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://kgyuvurtwywzcnxqodzp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtneXV2dXJ0d3l3emNueHFvZHpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5OTYyODksImV4cCI6MjA3MTU3MjI4OX0.n4MpZ4770X1gbLMp0ZArN-dzC9_apxg13AlrMCN-0MQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let currentUser = null;
        let users = [];
        let filteredUsers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let selectedUserId = null;
        
        // Loading functions
        function showLoading(title = 'Memuat...', message = 'Mohon tunggu sebentar') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            
            mobileMenu.classList.toggle('open');
            mobileMenuOverlay.classList.toggle('open');
        }
        
        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showLoading('Memuat Data Pengguna...', 'Mengambil data pengguna');
            
            // Check user session
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = {
                        id: user.uid,
                        email: user.email
                    };
                    
                    // Check if user is admin
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.role !== 'admin') {
                            // User is not admin, redirect to home
                            window.location.href = 'index.html';
                            return;
                        }
                    } else {
                        // User data not found, redirect to home
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    // Load users data
                    await loadUsers();
                    
                    // Setup event listeners
                    setupEventListeners();
                } else {
                    // User is signed out, redirect to login
                    window.location.href = 'index.html';
                }
                
                hideLoading();
            });
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterUsers();
            });
            
            // Status filter
            document.getElementById('statusFilter').addEventListener('change', function(e) {
                filterUsers();
            });
        }
        
        // Load users
        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                users = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    users.push({
                        id: doc.id,
                        ...userData
                    });
                });
                
                // Filter users
                filterUsers();
                
                // Update stats
                updateStats();
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Gagal memuat data pengguna', 'error');
            }
        }
        
        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredUsers = users.filter(user => {
                // Filter by search term
                const matchesSearch = searchTerm === '' || 
                    (user.firstName && user.firstName.toLowerCase().includes(searchTerm)) ||
                    (user.lastName && user.lastName.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.phone && user.phone.includes(searchTerm));
                
                // Filter by status
                let matchesStatus = true;
                if (statusFilter === 'verified') {
                    matchesStatus = user.ktpVerified === true;
                } else if (statusFilter === 'pending') {
                    matchesStatus = user.ktpUploaded === true && user.ktpVerified !== true;
                } else if (statusFilter === 'not-uploaded') {
                    matchesStatus = user.ktpUploaded !== true;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Render users table
            renderUsersTable();
            
            // Render pagination
            renderPagination();
        }
        
        // Update stats
        function updateStats() {
            const totalUsers = users.length;
            const verifiedUsers = users.filter(user => user.ktpVerified).length;
            const pendingUsers = users.filter(user => user.ktpUploaded && !user.ktpVerified).length;
            
            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('verifiedUsersCount').textContent = verifiedUsers;
            document.getElementById('pendingUsersCount').textContent = pendingUsers;
        }
        
        // Render users table
        function renderUsersTable() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada pengguna yang ditemukan
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredUsers.length);
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
            
            paginatedUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // Format date
                let createdDate = 'Tidak diketahui';
                if (user.createdAt) {
                    const date = user.createdAt.toDate ? 
                        new Date(user.createdAt.toDate()) : 
                        new Date(user.createdAt);
                    createdDate = date.toLocaleDateString('id-ID');
                }
                
                // Determine status
                let statusBadge = '';
                if (user.ktpVerified) {
                    statusBadge = '<span class="status-badge verified">Terverifikasi</span>';
                } else if (user.ktpUploaded) {
                    statusBadge = '<span class="status-badge pending">Menunggu Verifikasi</span>';
                } else {
                    statusBadge = '<span class="status-badge not-uploaded">Belum Upload</span>';
                }
                
                // Determine action buttons
                let actionButtons = '';
                if (user.ktpUploaded && !user.ktpVerified) {
                    actionButtons = `
                        <button onclick="openVerificationModal('${user.id}')" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-check-circle"></i> Verifikasi
                        </button>
                    `;
                }
                
                actionButtons += `
                    <button onclick="viewUserDetails('${user.id}')" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-eye"></i> Detail
                    </button>
                `;
                
                // User avatar
                const userAvatar = user.profileImageUrl || 'https://via.placeholder.com/40';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <img class="user-avatar" src="${userAvatar}" alt="${user.firstName || ''} ${user.lastName || ''}">
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.firstName || ''} ${user.lastName || ''}</div>
                                <div class="text-sm text-gray-500">${user.email || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${user.phone || '-'}</div>
                        <div class="text-sm text-gray-500">${user.address || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${createdDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${actionButtons}
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            // Update pagination info
            document.getElementById('startItem').textContent = filteredUsers.length > 0 ? startIndex + 1 : 0;
            document.getElementById('endItem').textContent = endIndex;
            document.getElementById('totalItems').textContent = filteredUsers.length;
        }
        
        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            // Previous button
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('prevPageMobile').disabled = currentPage === 1;
            
            // Next button
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('nextPageMobile').disabled = currentPage === totalPages || totalPages === 0;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                pageNumbers.appendChild(createPageButton(1));
                if (startPage > 2) {
                    pageNumbers.appendChild(createPageEllipsis());
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbers.appendChild(createPageEllipsis());
                }
                pageNumbers.appendChild(createPageButton(totalPages));
            }
        }
        
        // Create page button
        function createPageButton(page) {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                page === currentPage 
                    ? 'z-10 bg-orange-50 border-orange-500 text-orange-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
            }`;
            button.textContent = page;
            button.onclick = () => goToPage(page);
            return button;
        }
        
        // Create page ellipsis
        function createPageEllipsis() {
            const span = document.createElement('span');
            span.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700';
            span.textContent = '...';
            return span;
        }
        
        // Change page
        function changePage(direction) {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }
            
            renderUsersTable();
            renderPagination();
        }
        
        // Go to page
        function goToPage(page) {
            currentPage = page;
            renderUsersTable();
            renderPagination();
        }
        
        // Open verification modal
        async function openVerificationModal(userId) {
            selectedUserId = userId;
            
            try {
                // Get user data
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showNotification('Pengguna tidak ditemukan', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Update modal with user data
                document.getElementById('modalUserAvatar').src = userData.profileImageUrl || 'https://via.placeholder.com/40';
                document.getElementById('modalUserName').textContent = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'User';
                document.getElementById('modalUserEmail').textContent = userData.email || '';
                document.getElementById('modalKtpImage').src = userData.ktpUrl || 'https://via.placeholder.com/600';
                document.getElementById('verificationNotes').value = '';
                
                // Show modal
                document.getElementById('verificationModal').classList.add('show');
            } catch (error) {
                console.error('Error opening verification modal:', error);
                showNotification('Gagal membuka modal verifikasi', 'error');
            }
        }
        
        // Close verification modal
        function closeVerificationModal() {
            document.getElementById('verificationModal').classList.remove('show');
            selectedUserId = null;
        }
        
        // Approve verification
        async function approveVerification() {
            if (!selectedUserId) return;
            
            const notes = document.getElementById('verificationNotes').value;
            
            showLoading('Menyetujui Verifikasi...', 'Mohon tunggu sebentar');
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(selectedUserId).update({
                    ktpVerified: true,
                    ktpVerifiedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    ktpVerifiedBy: currentUser.id,
                    ktpVerifiedNotes: notes
                });
                
                // Update local users array
                const userIndex = users.findIndex(user => user.id === selectedUserId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        ktpVerified: true,
                        ktpVerifiedDate: new Date(),
                        ktpVerifiedBy: currentUser.id,
                        ktpVerifiedNotes: notes
                    };
                }
                
                // Close modal
                closeVerificationModal();
                
                // Refresh users table
                filterUsers();
                
                // Update stats
                updateStats();
                
                hideLoading();
                showNotification('Verifikasi berhasil disetujui', 'success');
            } catch (error) {
                console.error('Error approving verification:', error);
                hideLoading();
                showNotification('Gagal menyetujui verifikasi', 'error');
            }
        }
        
        // Reject verification
        async function rejectVerification() {
            if (!selectedUserId) return;
            
            const notes = document.getElementById('verificationNotes').value;
            
            if (!notes.trim()) {
                showNotification('Silakan tambahkan catatan untuk penolakan verifikasi', 'error');
                return;
            }
            
            showLoading('Menolak Verifikasi...', 'Mohon tunggu sebentar');
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(selectedUserId).update({
                    ktpUploaded: false,
                    ktpUrl: null,
                    ktpUploadDate: null,
                    ktpRejected: true,
                    ktpRejectedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    ktpRejectedBy: currentUser.id,
                    ktpRejectedNotes: notes
                });
                
                // Update local users array
                const userIndex = users.findIndex(user => user.id === selectedUserId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        ktpUploaded: false,
                        ktpUrl: null,
                        ktpUploadDate: null,
                        ktpRejected: true,
                        ktpRejectedDate: new Date(),
                        ktpRejectedBy: currentUser.id,
                        ktpRejectedNotes: notes
                    };
                }
                
                // Close modal
                closeVerificationModal();
                
                // Refresh users table
                filterUsers();
                
                // Update stats
                updateStats();
                
                hideLoading();
                showNotification('Verifikasi berhasil ditolak', 'success');
            } catch (error) {
                console.error('Error rejecting verification:', error);
                hideLoading();
                showNotification('Gagal menolak verifikasi', 'error');
            }
        }
        
        // View user details
        function viewUserDetails(userId) {
            // Redirect to user details page
            window.location.href = `detail-pengguna.html?id=${userId}`;
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Logout
        async function logout() {
            showLoading('Keluar...', 'Mengakhiri sesi');
            
            try {
                await auth.signOut();
                
                hideLoading();
                
                // Redirect to login page
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error logging out:', error);
                hideLoading();
                showNotification('Gagal keluar. Silakan coba lagi.', 'error');
            }
        }
    </script>
</body>
</html>
